/**
 * Bundle of report-core
 * Version: 1.0.3
 * Auth: marvin1023
 * Generated: 2022-10-02
 */

!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):(t="undefined"!=typeof globalThis?globalThis:t||self).ReportCore=e()}(this,(function(){"use strict";const t=({url:t,data:e,onReportSuccess:n,onReportFail:s})=>{wx.request({url:t,data:e,method:"POST",header:{"Content-Type":"application/json;charset=UTF-8"},success:()=>{n()},fail:t=>{s(t)}})},e=({url:t,data:e,onReportSuccess:n,onReportFail:s})=>{const o=new XMLHttpRequest;o.open("POST",t),o.setRequestHeader("Content-type","application/json; charset=utf-8"),o.send(JSON.stringify(e)),o.onload=function(){o.status>=200&&o.status<300?n():s(new Error(`${o.status}: ${o.statusText}`))},o.onerror=function(){s(new Error("请求失败"))}};function n(){let n;return"undefined"!=typeof XMLHttpRequest?n=e:"undefined"!=typeof wx&&(n=t),n}return class{constructor(t){this.baseData={},this.unreportEventData={},this.reportingEventData={},this.init(t)}init(t){const e={maxNum:4,intervalTime:3e3,eventKey:"uuid",pollIsOn:!0,adapter:n()};this.options=Object.assign(e,t),this.options.url?(this.initChild&&this.initChild(t),this.options.pollIsOn&&this.pollRun()):console.error("url is required.")}updateBaseData(t){Object.assign(this.baseData,t)}pollRun(){const{intervalTime:t}=this.options;this.timer=setTimeout((()=>{this.send(),this.pollRun()}),t)}pollStop(){this.timer&&clearTimeout(this.timer)}send(t=this.getEvents(),e=!1){const{length:n}=t;if(0===n)return;const s=this.options.maxNum;if(n<=s)return void this.doSend(t,e);const o=Math.ceil(n/s);for(let n=0;n<o;n++){const o=t.slice(n*s,(n+1)*s);this.doSend(o,e)}}doSend(t,e){const n=Object.assign(Object.assign({},this.baseData),{events:t}),{url:s,backup:o}=this.options;this.dispatch(s,n,e),!o||o.filter&&!o.filter(t)||this.dispatch(o.url,n,e)}dispatch(t,e,n=!1){var s,o,i;const{adapter:r,onReportSuccess:a,onReportFail:l,onReportBefore:c}=this.options,{events:u}=e;if(!t)throw new Error("please call init before");const h=null==c?void 0:c(t,e,n);if(!1===h)return;h&&h.constructor===Object&&(t=null!==(s=h.url)&&void 0!==s?s:t,e=null!==(o=h.data)&&void 0!==o?o:e,n=null!==(i=h.isImmediate)&&void 0!==i?i:n);const p=Date.now();r({url:t,data:e,onReportSuccess:()=>{null==a||a(u,{requestStartTime:p,url:t,isImmediate:n}),n||this.cleanEvents(u,1)},onReportFail:e=>{null==l||l(e,u,{requestStartTime:p,url:t,isImmediate:n}),n?this.concatEvents(u):this.cleanEvents(u,0)}})}report(t,e=!1){const n=Array.isArray(t)?t:[t];n.forEach((t=>{t[this.options.eventKey]||(t.uuid=this.generateUUID())})),e?this.send(n,!0):this.concatEvents(n)}reportAll(){this.send()}generateUUID(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(t=>{const e=16*Math.random()|0;return("x"==t?e:3&e|8).toString(16)}))}getEvents(){const t=[],e=this.getUnreportEventData(),{reportingEventData:n}=this;return Object.keys(e).forEach((s=>{if(!n[s]){const o=e[s];t.push(o),n[s]=o}})),t}concatEvents(t){if(!t||0===t.length)return;const e=this.getUnreportEventData();for(const n of t){e[n[this.options.eventKey]]=n}this.setUnreportEventData(e),Object.keys(e).length-Object.keys(this.reportingEventData).length>=this.options.maxNum&&this.send()}getUnreportEventData(){return this.unreportEventData}setUnreportEventData(t){this.unreportEventData=t}cleanEvents(t,e=0){const n=0===e?{}:this.getUnreportEventData(),{reportingEventData:s}=this;t.forEach((t=>{const o=t[this.options.eventKey];s[o]&&delete s[o],1===e&&n[o]&&delete n[o]})),1===e&&this.setUnreportEventData(n)}}}));
